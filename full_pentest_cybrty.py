#!/usr/bin/env python3
"""
Full Penetration Test on https://cybrty.com
This script performs a comprehensive penetration test using the PenTest AI API
"""

import requests
import json
import time
from datetime import datetime
import sys

API_BASE = "http://localhost:8000"
TARGET = "cybrty.com"

def print_banner():
    """Print test banner"""
    print("=" * 80)
    print("ğŸ¯ COMPREHENSIVE PENETRATION TEST")
    print("=" * 80)
    print(f"ğŸŒ Target: https://{TARGET}")
    print(f"ğŸ•’ Started: {datetime.now()}")
    print(f"ğŸ”§ API Endpoint: {API_BASE}")
    print("=" * 80)

def test_api_connection():
    """Test if API is available"""
    print("\nğŸ“¡ Testing API Connection...")
    try:
        response = requests.get(f"{API_BASE}/health", timeout=5)
        if response.status_code == 200:
            print("âœ… API Server is operational")
            return True
        else:
            print(f"âŒ API Server returned status {response.status_code}")
            return False
    except Exception as e:
        print(f"âŒ Failed to connect to API: {e}")
        return False

def get_available_tools():
    """Get list of available penetration testing tools"""
    print("\nğŸ”§ Getting Available Tools...")
    try:
        response = requests.get(f"{API_BASE}/tools", timeout=10)
        if response.status_code == 200:
            tools = response.json()
            print(f"âœ… Found {len(tools)} available tools:")
            for tool in tools:
                print(f"   â€¢ {tool['name']}: {tool['description']}")
            return [tool['name'] for tool in tools]
        else:
            print(f"âŒ Failed to get tools: {response.status_code}")
            return []
    except Exception as e:
        print(f"âŒ Error getting tools: {e}")
        return []

def execute_individual_tools(tools):
    """Execute individual tools against the target"""
    print(f"\nğŸ¯ Executing Individual Tools on {TARGET}...")
    results = {}
    
    # Key tools for web application testing
    priority_tools = ['nmap', 'nikto', 'zap', 'burp', 'sqlmap']
    
    for tool in priority_tools:
        if tool in tools:
            print(f"\nğŸ” Executing {tool.upper()}...")
            try:
                payload = {
                    "target": TARGET,
                    "scope": "comprehensive",
                    "tools": [tool],
                    "additional_params": {
                        "comprehensive_scan": True,
                        "web_target": True
                    }
                }
                
                response = requests.post(
                    f"{API_BASE}/invokePentest",
                    json=payload,
                    timeout=120  # 2 minutes per tool
                )
                
                if response.status_code == 200:
                    result = response.json()
                    results[tool] = result
                    print(f"âœ… {tool.upper()} completed successfully")
                    
                    # Show brief summary
                    if 'results' in result and 'tool_results' in result['results']:
                        tool_result = result['results']['tool_results'].get(tool, 'No specific output')
                        print(f"   ğŸ“Š Result: {str(tool_result)[:200]}...")
                else:
                    print(f"âŒ {tool.upper()} failed: HTTP {response.status_code}")
                    print(f"   Response: {response.text[:200]}...")
                    
            except Exception as e:
                print(f"âŒ Error executing {tool}: {e}")
                
            # Brief pause between tools
            time.sleep(2)
    
    return results

def execute_comprehensive_pentest():
    """Execute the full penetration testing workflow"""
    print(f"\nğŸš€ Executing Comprehensive Penetration Test on {TARGET}...")
    
    try:
        payload = {
            "target": TARGET,
            "scope": "comprehensive",
            "agents": ["recon", "vulnerability", "exploitation", "reporting"],
            "additional_params": {
                "web_application_test": True,
                "domain_enumeration": True,
                "vulnerability_assessment": True,
                "safe_exploitation": True,
                "comprehensive_reporting": True
            }
        }
        
        print("ğŸ“ Payload:")
        print(json.dumps(payload, indent=2))
        
        print("\nâ³ Executing comprehensive pentest (this may take several minutes)...")
        response = requests.post(
            f"{API_BASE}/invokePentest",
            json=payload,
            timeout=600  # 10 minutes timeout
        )
        
        if response.status_code == 200:
            result = response.json()
            print("âœ… Comprehensive penetration test completed successfully!")
            
            # Extract session ID if available
            session_id = None
            if 'results' in result and 'session_id' in result['results']:
                session_id = result['results']['session_id']
                print(f"ğŸ“ Session ID: {session_id}")
            
            return result, session_id
        else:
            print(f"âŒ Comprehensive pentest failed: HTTP {response.status_code}")
            print(f"Response: {response.text}")
            return None, None
            
    except Exception as e:
        print(f"âŒ Error executing comprehensive pentest: {e}")
        return None, None

def get_session_analytics(session_id):
    """Get analytics for the penetration test session"""
    if not session_id:
        print("\nâš ï¸  No session ID available for analytics")
        return
    
    print(f"\nğŸ“Š Getting Session Analytics for {session_id}...")
    
    try:
        # Get session summary
        response = requests.get(f"{API_BASE}/sessions/{session_id}/summary", timeout=30)
        if response.status_code == 200:
            summary = response.json()
            print("âœ… Session Summary:")
            print(json.dumps(summary, indent=2))
        else:
            print(f"âŒ Failed to get session summary: {response.status_code}")
    except Exception as e:
        print(f"âŒ Error getting session analytics: {e}")

def get_database_statistics():
    """Get MongoDB database statistics"""
    print("\nğŸ’¾ Getting Database Statistics...")
    
    try:
        response = requests.get(f"{API_BASE}/database/stats", timeout=30)
        if response.status_code == 200:
            stats = response.json()
            print("âœ… Database Statistics:")
            print(json.dumps(stats, indent=2))
        else:
            print(f"âŒ Failed to get database stats: {response.status_code}")
    except Exception as e:
        print(f"âŒ Error getting database statistics: {e}")

def get_recent_agent_actions():
    """Get recent agent actions from the database"""
    print("\nğŸ¤– Getting Recent Agent Actions...")
    
    try:
        response = requests.get(f"{API_BASE}/agents/actions?limit=10", timeout=30)
        if response.status_code == 200:
            actions = response.json()
            print(f"âœ… Found {actions['total_count']} agent actions")
            print("Recent actions:")
            for action in actions['agent_actions'][:5]:
                print(f"   â€¢ {action['agent_role']}: {action['action_type']} at {action['timestamp']}")
        else:
            print(f"âŒ Failed to get agent actions: {response.status_code}")
    except Exception as e:
        print(f"âŒ Error getting agent actions: {e}")

def main():
    """Main test execution"""
    print_banner()
    
    # Step 1: Test API connection
    if not test_api_connection():
        print("âŒ Cannot proceed without API connection")
        sys.exit(1)
    
    # Step 2: Get available tools
    tools = get_available_tools()
    if not tools:
        print("âŒ No tools available")
        sys.exit(1)
    
    # Step 3: Execute individual tools (quick tests)
    print("\n" + "="*60)
    print("ğŸ”§ PHASE 1: INDIVIDUAL TOOL EXECUTION")
    print("="*60)
    individual_results = execute_individual_tools(tools)
    
    # Step 4: Execute comprehensive penetration test
    print("\n" + "="*60)
    print("ğŸ¯ PHASE 2: COMPREHENSIVE PENETRATION TEST")
    print("="*60)
    comprehensive_result, session_id = execute_comprehensive_pentest()
    
    # Step 5: Get analytics and statistics
    print("\n" + "="*60)
    print("ğŸ“Š PHASE 3: ANALYTICS AND REPORTING")
    print("="*60)
    
    if session_id:
        get_session_analytics(session_id)
    
    get_database_statistics()
    get_recent_agent_actions()
    
    # Final summary
    print("\n" + "="*80)
    print("âœ… FULL PENETRATION TEST COMPLETED")
    print("="*80)
    print(f"ğŸ¯ Target: {TARGET}")
    print(f"ğŸ•’ Completed: {datetime.now()}")
    print(f"ğŸ”§ Individual tools executed: {len(individual_results)}")
    print(f"ğŸš€ Comprehensive test: {'âœ… Success' if comprehensive_result else 'âŒ Failed'}")
    print(f"ğŸ“ Session ID: {session_id or 'N/A'}")
    print("\nğŸ“‹ All results have been logged to MongoDB for detailed analysis")
    print("ğŸ’¡ Check the API endpoints for detailed tool outputs and agent actions")
    print("="*80)

if __name__ == "__main__":
    main()
